# Copilot Instructions for ALTOLNM

## Project Overview

**ALTOLNM** is a single-file Python utility for Windows that bridges two flight simulation tools:

- **MSFS Addons Linker 2024** – manages addon scenery for Microsoft Flight Simulator 2024.
- **Little NavMap** – a flight planning tool that uses a local SQLite database of airports.

Little NavMap cannot automatically detect addon airports in MSFS 2024. ALTOLNM fixes this by reading the Addons Linker CSV database and updating the Little NavMap SQLite database to flag matching airports as addons (`is_addon = 1`).

Both tools' developers have granted permission for ALTOLNM to be distributed.

---

## Repository Structure

```
ALTOLNM/
├── altolnm.py      # Entire application – single Python source file
├── icon.ico        # Application icon used during PyInstaller build
├── README.md       # End-user documentation
├── LICENSE         # License file
└── .gitignore      # Excludes build/, dist/, venv/, __pycache__, *.spec, IDE dirs
```

There are **no tests**, **no CI/CD workflows**, and **no additional Python packages** beyond what is installed manually.

---

## Dependencies

| Package      | Purpose                                      | How to install        |
|--------------|----------------------------------------------|-----------------------|
| `colorama`   | Cross-platform ANSI color output in terminal | `pip install colorama` |
| `pyinstaller`| Build standalone `.exe` from Python source   | `pip install pyinstaller` |

Standard library modules used: `os`, `sys`, `sqlite3`, `csv`, `subprocess`.

---

## Building the Executable

Run from the repository root (Windows, with PyInstaller installed):

```bash
pyinstaller.exe --onefile .\altolnm.py --icon=icon.ico
```

Output: `dist\altolnm.exe`  
Build artifacts (`build/`, `dist/`, `*.spec`) are excluded from version control via `.gitignore`.

---

## Running the Application

```bash
python altolnm.py
```

The application is **interactive** and prompts the user to confirm or override default file paths:

1. **MSFS Addons Linker CSV** (required):  
   `C:\ProgramData\MSFS Addons Linker 2024\Data\Addons_ICAO.bin`

2. **Optional custom CSV** (auto-detected alongside main CSV):  
   `C:\ProgramData\MSFS Addons Linker 2024\Data\Addons_ICAO_Custom.bin`

3. **Little NavMap SQLite database** (required):  
   `%APPDATA%\ABarthel\little_navmap_db\little_navmap_msfs24.sqlite`

The CSV files use `;` as a delimiter. Each row has two fields:
- Field 1: local scenery path
- Field 2: airport ICAO code

---

## How the Code Works

All logic lives in `altolnm.py`. Key functions:

| Function | Description |
|---|---|
| `detect_encoding(file_path, encodings)` | Tries a list of encodings until one successfully reads the file. |
| `check_csv_file(file_path)` | Validates the CSV file exists and is non-empty. |
| `check_sqlite_db(file_path)` | Validates the SQLite database exists and has an `airport` table. |
| `reset_airport_table(sqlite_path)` | Clears previous ALTOLNM-flagged airports (`bgl_filename = 'ALTOLNM'`) before a fresh update. |
| `get_airport_info_from_csv(csv_path)` | Reads the CSV and returns a list of `(ident, scenery_local_path)` tuples. |
| `update_airport_with_info(sqlite_path, airport_info)` | Updates `is_addon`, `scenery_local_path`, and `bgl_filename` in the `airport` table. |
| `main()` | Orchestrates the full interactive workflow. |

### Database interaction

The utility **never inserts or deletes** rows. It only `UPDATE`s existing rows in the `airport` table:

```sql
-- Reset phase (clears prior run)
UPDATE airport SET is_addon = 0, scenery_local_path = '' WHERE bgl_filename = 'ALTOLNM';

-- Update phase (marks addon airports)
UPDATE airport SET is_addon = 1, scenery_local_path = ?, bgl_filename = 'ALTOLNM'
WHERE UPPER(ident) = ?;
```

The `bgl_filename` column is repurposed as a run marker (`'ALTOLNM'`) to identify rows touched by this utility.

---

## Coding Conventions

- **Single-file design**: keep all application logic in `altolnm.py`.
- **Error handling**: wrap all file I/O and database operations in `try/except`. Always close database connections in `finally` blocks.
- **Colorama**: use `Fore.GREEN` / `Fore.RED` and `Style.RESET_ALL` for status output. Call `colorama.init()` at module level.
- **Interactive output**: use `sys.stdout.write("\r\033[K" + status)` with `sys.stdout.flush()` for in-place line updates during long loops.
- **Encoding detection**: always call `detect_encoding()` before opening CSV files; never assume UTF-8.
- **Target platform**: Windows. Paths use raw strings (`r"C:\..."`) and `os.path.join()`.

---

## Known Limitations / Troubleshooting

- The `Addons_ICAO.bin` CSV is generated by running **Tools → Scan ICAO / Check for duplicates** inside MSFS Addons Linker 2024. If the file is missing, instruct the user to run that step first.
- The Little NavMap database must already be populated with MSFS 2024 airports before running ALTOLNM.
- Run with administrative privileges if file access errors occur.
- If encoding detection fails, extend the `encodings` list in `detect_encoding()`.

---

## No Test Infrastructure

There are no automated tests in this repository. When validating changes:

1. Run `python altolnm.py` with real or mock files.
2. Inspect the SQLite database with a tool like DB Browser for SQLite to confirm `is_addon` and `scenery_local_path` were set correctly.
3. To mock the CSV, create a `;`-delimited text file with `path;ICAO` rows.
4. To mock the SQLite database, create a minimal SQLite file containing an `airport` table with `ident`, `is_addon`, `scenery_local_path`, and `bgl_filename` columns.
